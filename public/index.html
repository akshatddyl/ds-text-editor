<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS Text Editor</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-sidebar: #252526;
            --bg-active: #37373d;
            --text-main: #cccccc;
            --accent: #007acc;
            --border: #3e3e42;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        body {
            display: flex;
            height: 100vh;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 10px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
        }

        .file-item {
            padding: 8px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .file-item:hover {
            background-color: #2a2d2e;
        }

        .file-item.active {
            background-color: var(--bg-active);
            color: white;
        }

        .file-actions button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            margin-left: 5px;
        }

        .file-actions button:hover {
            color: white;
        }

        .sidebar-controls {
            padding: 10px;
            border-top: 1px solid var(--border);
        }

        .btn {
            width: 100%;
            padding: 8px;
            background-color: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
        }

        /* Main Editor */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background-color: var(--bg-sidebar);
            overflow-x: auto;
            height: 35px;
        }

        .tab {
            padding: 8px 20px;
            background-color: #2d2d2d;
            color: #969696;
            cursor: pointer;
            border-right: 1px solid var(--border);
            display: flex;
            align-items: center;
            font-size: 13px;
        }

        .tab.active {
            background-color: var(--bg-dark);
            color: white;
            border-top: 2px solid var(--accent);
        }

        .tab-close {
            margin-left: 8px;
            font-size: 12px;
        }

        /* Toolbar */
        .toolbar {
            padding: 5px 10px;
            background-color: var(--bg-dark);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar input {
            background: #3c3c3c;
            border: 1px solid #555;
            color: white;
            padding: 4px;
        }

        .toolbar button {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 4px 8px;
            cursor: pointer;
        }

        .toolbar button:hover {
            background: #444;
        }

        /* Editor Area */
        #editor {
            flex: 1;
            padding: 20px;
            outline: none;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        /* Highlighting & Suggestions */
        .highlight {
            background-color: #6b4e00;
            color: white;
        }

        #suggestion-box {
            position: absolute;
            background: #2d2d30;
            border: 1px solid #454545;
            display: none;
            z-index: 1000;
            width: 150px;
        }

        .suggestion-item {
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background-color: var(--accent);
            color: white;
        }

        /* Logs */
        .status-bar {
            height: 25px;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">Explorer</div>
        <div class="file-list" id="fileList">
            <!-- Files injected here -->
        </div>
        <div class="sidebar-controls">
            <button class="btn" onclick="createNewFile()">+ New File</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main">
        <!-- Tabs -->
        <div class="tabs" id="tabsContainer"></div>

        <!-- Toolbar for Search/Replace -->
        <div class="toolbar">
            <input type="text" id="searchInput" placeholder="Search (Boyer-Moore)">
            <button onclick="performSearch()">Find</button>
            <input type="text" id="replaceInput" placeholder="Replace">
            <button onclick="performReplace()">Replace</button>
            <span style="flex:1"></span>
            <!-- Added explicit type="button" to prevent form submission behavior -->
            <button type="button" onclick="triggerUndo()">Undo (Ctrl+Z)</button>
            <button type="button" onclick="triggerRedo()">Redo (Ctrl+Y)</button>
        </div>

        <!-- Editor -->
        <div id="editor" contenteditable="true" spellcheck="false"></div>

        <!-- Autocomplete Popup -->
        <div id="suggestion-box"></div>

        <!-- Footer / Logs -->
        <div class="status-bar" id="statusBar">Ready - DS Backend Connected</div>
    </div>

    <script>
        let currentFile = null;
        let openFiles = [];
        let debounceTimer = null;
        const editor = document.getElementById('editor');
        const suggestionBox = document.getElementById('suggestion-box');

        // --- INITIALIZATION ---
        async function loadFiles() {
            try {
                const res = await fetch('/api/files');
                const files = await res.json();
                const list = document.getElementById('fileList');
                list.innerHTML = '';
                files.forEach(f => {
                    const div = document.createElement('div');
                    div.className = `file-item ${currentFile === f ? 'active' : ''}`;
                    div.innerHTML = `
                        <span onclick="openFile('${f}')">ðŸ“„ ${f}</span>
                        <div class="file-actions">
                            <button onclick="renameFile('${f}')">âœŽ</button>
                            <button onclick="deleteFile('${f}')">ðŸ—‘</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
                // Open the default file if none is open
                if (!currentFile && files.length > 0) {
                    openFile(files[0]);
                }
            } catch (error) {
                log('Error loading files. Is the server running?');
                console.error('Fetch error:', error);
            }
        }

        async function openFile(name) {
            currentFile = name;
            if (!openFiles.includes(name)) openFiles.push(name);
            renderTabs();
            loadFiles();

            try {
                const res = await fetch(`/api/file/${name}`);
                const data = await res.json();
                editor.innerText = data.content;
                log(`Opened ${name}`);
            } catch (error) {
                log(`Error opening file ${name}`);
                console.error('Fetch error:', error);
            }
        }

        function renderTabs() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = openFiles.map(f => `
                <div class="tab ${f === currentFile ? 'active' : ''}" onclick="openFile('${f}')">
                    ${f} <span class="tab-close" onclick="closeTab(event, '${f}')">âœ•</span>
                </div>
            `).join('');
        }

        function closeTab(e, name) {
            e.stopPropagation();
            openFiles = openFiles.filter(f => f !== name);
            if (currentFile === name) currentFile = openFiles[0] || null;
            if (currentFile) openFile(currentFile);
            else editor.innerText = "";
            renderTabs();
        }

        async function createNewFile() {
            const name = prompt("Enter file name (e.g., doc.txt):");
            if (!name) return;
            await fetch('/api/files', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            loadFiles();
        }

        async function deleteFile(name) {
            // Replaced alert with custom confirmation placeholder
            const confirmed = confirm(`Delete ${name}?`);
            if (!confirmed) return;
            await fetch(`/api/file/${name}`, { method: 'DELETE' });
            if (currentFile === name) {
                closeTab({ stopPropagation: () => { } }, name);
            }
            loadFiles();
        }

        async function renameFile(oldName) {
            const newName = prompt("New name:", oldName);
            if (!newName) return;
            await fetch('/api/files', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName, oldName })
            });
            if (openFiles.includes(oldName)) {
                openFiles[openFiles.indexOf(oldName)] = newName;
                if (currentFile === oldName) currentFile = newName;
            }
            loadFiles();
            renderTabs();
        }

        // --- EDITOR LOGIC (Sync with Backend Rope) ---

        // Helper function to force save immediately
        async function saveCurrentState() {
            if (!currentFile) return;

            await fetch(`/api/file/${currentFile}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: editor.innerText })
            });

            debounceTimer = null; // Reset timer variable
        }

        editor.addEventListener('input', (e) => {
            // Clear any pending save
            if (debounceTimer) clearTimeout(debounceTimer);

            // Autocomplete Logic
            const text = editor.innerText;
            const lastWord = text.split(/[\s\n]+/).pop();
            if (lastWord.length > 1) getSuggestions(lastWord);
            else suggestionBox.style.display = 'none';

            // Set new debounce timer (500ms)
            debounceTimer = setTimeout(() => {
                saveCurrentState();
                log('Saved to Backend Rope');
            }, 500);
        });

        // --- AUTOCOMPLETE (Trie) ---
        async function getSuggestions(prefix) {
            const lowerPrefix = prefix.toLowerCase();

            const res = await fetch('/api/autocomplete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prefix: lowerPrefix })
            });
            const data = await res.json();

            if (data.suggestions.length > 0) {
                // Get cursor position bounding box
                const selection = window.getSelection();
                if (selection.rangeCount === 0) return;
                const rect = selection.getRangeAt(0).getBoundingClientRect();

                suggestionBox.style.left = rect.left + 'px';
                suggestionBox.style.top = (rect.top + 20) + 'px';
                suggestionBox.style.display = 'block';

                suggestionBox.innerHTML = data.suggestions.map(s => {
                    const textToInsert = s.replace(lowerPrefix, '');

                    return `<div class="suggestion-item" onclick="insertText('${textToInsert}')">${s}</div>`;
                }).join('');

            } else {
                suggestionBox.style.display = 'none';
            }
        }

        function insertText(text) {
            // document.execCommand('insertText', ...) performs insertion and triggers input event naturally.
            document.execCommand('insertText', false, text);
            suggestionBox.style.display = 'none';
            editor.focus();
        }

        // --- SHORTCUTS & OPERATIONS ---
        document.addEventListener('keydown', async (e) => {
            // Check for Ctrl (or Cmd on Mac)
            if (e.ctrlKey || e.metaKey) {
                const key = e.key.toLowerCase();

                // 1. Mandatory: Prevent native browser actions for Undo/Redo/Save
                if (key === 's' || key === 'z' || key === 'y') {
                    e.preventDefault();
                }

                if (key === 's') {
                    if (debounceTimer) clearTimeout(debounceTimer); // Cancel pending
                    await saveCurrentState(); // Force Save
                    log('Saved (Ctrl+S)');
                }

                if (key === 'z') {
                    triggerUndo();
                }

                if (key === 'y') {
                    triggerRedo();
                }

                // Cut, Copy, Paste, Bold, Italic use browser's native document.execCommand
                if (key === 'x') { document.execCommand('cut'); }
                if (key === 'c') { document.execCommand('copy'); }
                if (key === 'b') { document.execCommand('bold'); }
                if (key === 'i') { document.execCommand('italic'); }
                // Paste (Ctrl+V or Cmd+V) should generally be allowed natively if contentEditable is used, 
                // but we block Ctrl+P since that is a print command.
                if (key === 'p') { /* Note: Ctrl+P is typically Print. We keep it unhandled to avoid conflict */ }
            }
        });

        async function triggerUndo() {
            if (!currentFile) return;

            // CRITICAL: Flush pending state (if any) to the Undo Stack before asking for the previous state.
            if (debounceTimer) {
                clearTimeout(debounceTimer);
                await saveCurrentState();
            }

            const res = await fetch(`/api/file/${currentFile}/undo`, { method: 'POST' });
            if (res.ok) {
                const data = await res.json();
                editor.innerText = data.content;
                log("Undo performed (Stack Pop)");
            } else {
                log("Undo failed or stack empty.");
            }
        }

        async function triggerRedo() {
            if (!currentFile) return;

            // Flush pending state (if any) to the Redo Stack before asking for the next state.
            if (debounceTimer) {
                clearTimeout(debounceTimer);
                await saveCurrentState();
            }

            const res = await fetch(`/api/file/${currentFile}/redo`, { method: 'POST' });
            if (res.ok) {
                const data = await res.json();
                editor.innerText = data.content;
                log("Redo performed (Stack Push)");
            } else {
                log("Redo failed or stack empty.");
            }
        }

        // --- SEARCH (Boyer-Moore) ---
        async function performSearch() {
            const pattern = document.getElementById('searchInput').value;
            const text = editor.innerText;
            if (!pattern) return;

            const res = await fetch('/api/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, pattern })
            });
            const data = await res.json();

            log(`Found ${data.indices.length} matches via Boyer-Moore`);

            if (data.indices.length > 0) {
                // Using alert as a message box placeholder
                alert(`Pattern found at indices: ${data.indices.join(', ')}`);
            } else {
                alert("Not found");
            }
        }

        function performReplace() {
            const search = document.getElementById('searchInput').value;
            const replace = document.getElementById('replaceInput').value;
            if (!search) return;
            editor.innerText = editor.innerText.replaceAll(search, replace);

            // Trigger input to save changes to Rope
            editor.dispatchEvent(new Event('input'));
        }

        function log(msg) {
            document.getElementById('statusBar').innerText = msg;
            console.log(msg);
        }

        loadFiles();
    </script>
</body>

</html>
