<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS Text Editor</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-app: #0f0c29;
            --bg-sidebar: rgba(30, 30, 46, 0.9);
            --bg-editor: rgba(255, 255, 255, 0.05);
            --text-main: #e0e0e0;
            --text-muted: #949494;
            --accent: #7b2cbf;
            --border: rgba(255, 255, 255, 0.1);
            --font-ui: 'Inter', sans-serif;
            --font-code: 'Fira Code', monospace;
        }

        [data-theme="light"] {
            --bg-app: #f0f2f5;
            --bg-sidebar: #ffffff;
            --bg-editor: #ffffff;
            --text-main: #2d3436;
            --text-muted: #636e72;
            --accent: #0984e3;
            --border: #dfe6e9;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            background: var(--bg-app);
            color: var(--text-main);
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .brand {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
        }

        .file-item {
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-muted);
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
        }

        .file-item.active {
            background: var(--accent);
            color: white;
        }

        .file-actions {
            opacity: 0.5;
            display: flex;
            gap: 8px;
        }

        .file-item:hover .file-actions {
            opacity: 1;
        }

        .file-actions span {
            cursor: pointer;
            font-size: 14px;
        }

        .btn-sidebar {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: transparent;
            border: 1px dashed var(--border);
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
        }

        /* MAIN AREA */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar input {
            background: var(--bg-editor);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 6px 10px;
            border-radius: 4px;
            outline: none;
        }

        .btn-tool {
            background: var(--bg-editor);
            color: var(--text-main);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-tool:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-tool.active {
            background: var(--accent);
            color: white;
        }

        /* EDITOR GRID (SPLIT VIEW) */
        .editor-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1px;
            background: var(--border);
            padding: 0;
        }

        .editor-container.split {
            grid-template-columns: 1fr 1fr;
        }

        .editor-pane {
            background: var(--bg-app);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-pane.focused {
            box-shadow: inset 0 0 0 2px var(--accent);
        }

        .pane-header {
            padding: 5px 10px;
            font-size: 11px;
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .editor-content {
            flex: 1;
            padding: 20px;
            outline: none;
            overflow-y: auto;
            font-family: var(--font-code);
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* AUTOCOMPLETE */
        #suggestion-box {
            position: absolute;
            background: var(--bg-sidebar);
            border: 1px solid var(--border);
            display: none;
            z-index: 2000;
            min-width: 150px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
        }

        .suggestion-item:hover {
            background: var(--accent);
            color: white;
        }

        /* FOOTER */
        .stats-bar {
            height: 30px;
            background: var(--bg-sidebar);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 20px;
            font-size: 11px;
            gap: 15px;
            color: var(--text-muted);
        }

        /* MODE BADGE */
        .mode-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: #ff9f43;
            color: #222;
            font-weight: bold;
            display: none;
        }

        .mode-badge.visible {
            display: inline-block;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="brand">
            DS EDITOR
            <button style="background:none;border:none;color:inherit;cursor:pointer;" onclick="toggleTheme()">◑</button>
        </div>
        <div class="file-list" id="fileList"></div>
        <button class="btn-sidebar" onclick="createNewFile()">+ New File</button>
    </div>

    <div class="main">
        <div class="toolbar">
            <input type="text" id="searchInput" placeholder="Find...">
            <button class="btn-tool" onclick="performSearch()">Search</button>
            <input type="text" id="replaceInput" placeholder="Replace...">
            <button class="btn-tool" onclick="performReplace()">Replace</button>
            <div style="flex:1"></div>
            <span id="modeBadge" class="mode-badge" title="Running in Browser Simulation Mode (No Backend)">SIMULATION
                MODE</span>
            <button class="btn-tool" id="btnSplit" onclick="toggleSplit()">◫ Split View</button>
            <!-- Spell Check Button Removed Here -->
            <button class="btn-tool" onclick="triggerUndo()">↶ Undo</button>
            <button class="btn-tool" onclick="triggerRedo()">↷ Redo</button>
        </div>

        <div class="editor-container" id="editorContainer">
            <!-- Left Pane -->
            <div class="editor-pane focused" id="pane1" onclick="setFocus('pane1')">
                <div class="pane-header" id="header1">No File</div>
                <div class="editor-content" id="editor1" contenteditable="true" spellcheck="false"></div>
            </div>
            <!-- Right Pane (Hidden by default) -->
            <div class="editor-pane" id="pane2" onclick="setFocus('pane2')" style="display: none;">
                <div class="pane-header" id="header2">No File</div>
                <div class="editor-content" id="editor2" contenteditable="true" spellcheck="false"></div>
            </div>
        </div>

        <div id="suggestion-box"></div>

        <div class="stats-bar">
            <span id="statusMsg">Ready</span>
            <span>Ln <span id="lineCount">0</span></span>
            <span>Wd <span id="wordCount">0</span></span>
        </div>
    </div>

    <script>
        /**
         * CLIENT-SIDE BACKEND SIMULATION
         * This allows the UI to work in the preview window without a running Node.js server.
         * It mimics the exact behavior of server.js
         */
        class MockBackend {
            constructor() {
                this.files = {
                    'demo.txt': {
                        content: "Welcome to DS Editor (Simulation Mode).\nBecause no backend was found, all Data Structures (Rope, Trie, Stack) are running right here in your browser!",
                        history: this.createHistory()
                    }
                };
                this.trie = this.createTrie();
                this.initTrie();
            }

            createHistory() {
                return { undoStack: [], redoStack: [], maxSize: 50 };
            }

            createTrie() {
                return { root: { children: {}, isEndOfWord: false } };
            }

            initTrie() {
                const keywords = ["function", "return", "const", "let", "var", "import", "class", "console", "log", "async", "await", "structure", "rope", "trie", "stack", "hello", "world"];
                keywords.forEach(w => this.trieInsert(w));
            }

            trieInsert(word) {
                let node = this.trie.root;
                for (let char of word.toLowerCase()) {
                    if (!node.children[char]) node.children[char] = { children: {}, isEndOfWord: false };
                    node = node.children[char];
                }
                node.isEndOfWord = true;
            }

            trieFind(prefix) {
                let node = this.trie.root;
                for (let char of prefix.toLowerCase()) {
                    if (!node.children[char]) return [];
                    node = node.children[char];
                }
                return this._trieCollect(node, prefix.toLowerCase());
            }

            _trieCollect(node, prefix) {
                let res = [];
                if (node.isEndOfWord) res.push(prefix);
                for (let char in node.children) {
                    res = res.concat(this._trieCollect(node.children[char], prefix + char));
                }
                return res.slice(0, 8);
            }

            handleRequest(url, method, body) {
                const path = url.replace('/api/', '');

                // 1. LIST FILES
                if (path === 'files' && method === 'GET') {
                    return Object.keys(this.files);
                }

                // 2. CREATE/RENAME
                if (path === 'files' && method === 'POST') {
                    const { name, oldName } = body;
                    if (oldName && this.files[oldName]) {
                        this.files[name] = this.files[oldName];
                        delete this.files[oldName];
                    } else {
                        this.files[name] = { content: "", history: this.createHistory() };
                    }
                    return { success: true };
                }

                // 3. GET CONTENT
                if (path.startsWith('file/') && method === 'GET') {
                    const name = path.split('/')[1];
                    return this.files[name] ? { content: this.files[name].content } : null;
                }

                // 4. DELETE
                if (path.startsWith('file/') && method === 'DELETE') {
                    const name = path.split('/')[1];
                    delete this.files[name];
                    return { success: true };
                }

                // 5. UPDATE (Rope Logic Sim)
                if (path.includes('/update') && method === 'POST') {
                    const name = path.split('/')[1];
                    const f = this.files[name];
                    if (f && f.content !== body.text) {
                        this.saveState(f, f.content);
                        f.content = body.text;
                        // Learning
                        body.text.split(/[\s\n\.\,\!\?]+/).forEach(w => {
                            if (w.length > 2) this.trieInsert(w);
                        });
                    }
                    return { success: true };
                }

                // 6. UNDO
                if (path.includes('/undo') && method === 'POST') {
                    const name = path.split('/')[1];
                    const f = this.files[name];
                    if (f && f.history.undoStack.length > 0) {
                        const prev = f.history.undoStack.pop();
                        f.history.redoStack.push(f.content);
                        f.content = prev;
                        return { content: prev };
                    }
                    return { content: f ? f.content : "" };
                }

                // 7. REDO
                if (path.includes('/redo') && method === 'POST') {
                    const name = path.split('/')[1];
                    const f = this.files[name];
                    if (f && f.history.redoStack.length > 0) {
                        const next = f.history.redoStack.pop();
                        f.history.undoStack.push(f.content);
                        f.content = next;
                        return { content: next };
                    }
                    return { content: f ? f.content : "" };
                }

                // 8. AUTOCOMPLETE
                if (path === 'autocomplete') {
                    return { suggestions: this.trieFind(body.prefix) };
                }

                // 9. SEARCH (Boyer-Moore Sim)
                if (path === 'search') {
                    // Simple JS search for sim
                    const indices = [];
                    let pos = body.text.indexOf(body.pattern);
                    while (pos !== -1) { indices.push(pos); pos = body.text.indexOf(body.pattern, pos + 1); }
                    return { indices };
                }

                // Mock Spell Check removed

                return null;
            }

            saveState(fileObj, text) {
                fileObj.history.undoStack.push(text);
                if (fileObj.history.undoStack.length > 50) fileObj.history.undoStack.shift();
                fileObj.history.redoStack = [];
            }
        }

        // --- APP STATE ---
        const mockBackend = new MockBackend();
        let useMock = false; // Will be auto-detected

        let files = [];
        let activePaneId = 'pane1';
        let paneState = {
            pane1: { file: null, editor: document.getElementById('editor1') },
            pane2: { file: null, editor: document.getElementById('editor2') }
        };
        let isSplit = false;
        let debounceTimer = null;
        let currentPrefixStart = 0;
        const suggestionBox = document.getElementById('suggestion-box');

        // --- API WRAPPER (HANDLES BLOB/LOCAL ISSUES) ---
        async function apiCall(url, options = {}) {
            // 1. Check if we are in a blob/file environment where relative fetch fails
            if (window.location.protocol === 'blob:' || window.location.protocol === 'file:' || useMock) {
                useMock = true;
                document.getElementById('modeBadge').classList.add('visible');
                // Simulate network delay for realism
                await new Promise(r => setTimeout(r, 50));
                const body = options.body ? JSON.parse(options.body) : {};
                const result = mockBackend.handleRequest(url, options.method || 'GET', body);

                if (result) return { ok: true, json: async () => result };
                return { ok: false };
            }

            // 2. Try Real Fetch
            try {
                const res = await fetch(url, options);
                return res;
            } catch (e) {
                console.warn("Backend unreachable, switching to Simulation Mode.", e);
                useMock = true; // Fallback for subsequent requests
                document.getElementById('modeBadge').classList.add('visible');
                return apiCall(url, options); // Retry with mock
            }
        }

        // --- SPLIT VIEW LOGIC ---
        function toggleSplit() {
            isSplit = !isSplit;
            const container = document.getElementById('editorContainer');
            const pane2 = document.getElementById('pane2');
            const btn = document.getElementById('btnSplit');

            if (isSplit) {
                container.classList.add('split');
                pane2.style.display = 'flex';
                btn.classList.add('active');
                if (!paneState.pane2.file && paneState.pane1.file) {
                    openFile(paneState.pane1.file, 'pane2');
                }
                setFocus('pane2');
            } else {
                container.classList.remove('split');
                pane2.style.display = 'none';
                btn.classList.remove('active');
                setFocus('pane1');
            }
        }

        function setFocus(paneId) {
            activePaneId = paneId;
            document.querySelectorAll('.editor-pane').forEach(p => p.classList.remove('focused'));
            document.getElementById(paneId).classList.add('focused');
        }

        function getActiveEditor() { return paneState[activePaneId].editor; }
        function getActiveFile() { return paneState[activePaneId].file; }

        // --- FILE OPERATIONS ---
        async function loadFileList() {
            const res = await apiCall('/api/files');
            if (!res.ok) return;
            files = await res.json();
            const list = document.getElementById('fileList');
            list.innerHTML = '';
            files.forEach(f => {
                const activeClass = (paneState.pane1.file === f || paneState.pane2.file === f) ? 'active' : '';
                list.innerHTML += `
                    <div class="file-item ${activeClass}" onclick="openFile('${f}', '${activePaneId}')">
                        <span>${f}</span>
                        <div class="file-actions">
                            <span onclick="renameFile(event, '${f}')" title="Rename">✎</span>
                            <span onclick="deleteFile(event, '${f}')" title="Delete">×</span>
                        </div>
                    </div>
                `;
            });
        }

        async function openFile(name, targetPaneId) {
            const res = await apiCall(`/api/file/${name}`);
            if (!res.ok) return;
            const data = await res.json();

            paneState[targetPaneId].file = name;
            paneState[targetPaneId].editor.innerText = data.content;
            document.getElementById(targetPaneId === 'pane1' ? 'header1' : 'header2').innerText = name;

            updateStats();
            loadFileList();
        }

        async function createNewFile() {
            const name = prompt("Filename (e.g. notes.txt):");
            if (name) {
                await apiCall('/api/files', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                await loadFileList();
                openFile(name, activePaneId);
            }
        }

        async function renameFile(e, oldName) {
            e.stopPropagation();
            const newName = prompt("Rename to:", oldName);
            if (!newName || newName === oldName) return;

            await apiCall('/api/files', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName, oldName })
            });

            if (paneState.pane1.file === oldName) paneState.pane1.file = newName;
            if (paneState.pane2.file === oldName) paneState.pane2.file = newName;

            await loadFileList();
            if (paneState.pane1.file === newName) openFile(newName, 'pane1');
        }

        async function deleteFile(e, name) {
            e.stopPropagation();
            if (confirm(`Delete ${name}?`)) {
                await apiCall(`/api/file/${name}`, { method: 'DELETE' });
                if (paneState.pane1.file === name) { paneState.pane1.editor.innerText = ''; paneState.pane1.file = null; document.getElementById('header1').innerText = 'No File'; }
                if (paneState.pane2.file === name) { paneState.pane2.editor.innerText = ''; paneState.pane2.file = null; document.getElementById('header2').innerText = 'No File'; }
                loadFileList();
            }
        }

        async function saveToBackend(paneId) {
            const file = paneState[paneId].file;
            const text = paneState[paneId].editor.innerText;
            if (!file) return;

            await apiCall(`/api/file/${file}/update`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });
            log('Saved');
        }

        // --- EDITOR EVENTS ---
        ['editor1', 'editor2'].forEach(id => {
            const ed = document.getElementById(id);

            ed.addEventListener('click', () => setFocus(id === 'editor1' ? 'pane1' : 'pane2'));

            ed.addEventListener('input', () => {
                const pId = id === 'editor1' ? 'pane1' : 'pane2';
                setFocus(pId);
                updateStats();
                handleAutocomplete(ed);
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => saveToBackend(pId), 800);
            });
        });

        // --- UNDO / REDO ---
        async function triggerUndo() {
            const file = getActiveFile();
            if (!file) return;
            await saveToBackend(activePaneId);
            const res = await apiCall(`/api/file/${file}/undo`, { method: 'POST' });
            if (res.ok) {
                const d = await res.json();
                getActiveEditor().innerText = d.content;
                log('Undone');
            }
        }

        async function triggerRedo() {
            const file = getActiveFile();
            if (!file) return;
            await saveToBackend(activePaneId);
            const res = await apiCall(`/api/file/${file}/redo`, { method: 'POST' });
            if (res.ok) {
                const d = await res.json();
                getActiveEditor().innerText = d.content;
                log('Redone');
            }
        }

        // Check Spelling Function Removed

        // --- AUTOCOMPLETE UTILS ---
        function handleAutocomplete(editor) {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return;
            const range = selection.getRangeAt(0);
            const textPre = range.startContainer.textContent.slice(0, range.startOffset);
            const match = textPre.match(/([a-zA-Z]{2,})$/);

            if (match) {
                currentPrefixStart = range.startOffset - match[0].length;
                const prefix = match[0];

                apiCall('/api/autocomplete', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prefix })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.suggestions.length > 0) {
                            const rect = range.getBoundingClientRect();
                            suggestionBox.style.left = rect.left + 'px';
                            suggestionBox.style.top = (rect.bottom + 5) + 'px';
                            suggestionBox.style.display = 'block';
                            suggestionBox.innerHTML = data.suggestions.map(s =>
                                `<div class="suggestion-item" onmousedown="applySuggestion('${s}')">${s}</div>`
                            ).join('');
                        } else {
                            suggestionBox.style.display = 'none';
                        }
                    });
            } else {
                suggestionBox.style.display = 'none';
            }
        }

        window.applySuggestion = function (fullWord) {
            const editor = getActiveEditor();
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);

            range.setStart(range.startContainer, currentPrefixStart);
            range.deleteContents();
            range.insertNode(document.createTextNode(fullWord));
            range.collapse(false);

            suggestionBox.style.display = 'none';
            editor.focus();
            editor.dispatchEvent(new Event('input'));
        }

        // --- SHORTCUTS ---
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey) {
                const k = e.key.toLowerCase();
                if (['z', 'y', 's'].includes(k)) e.preventDefault();
                if (k === 'z') triggerUndo();
                if (k === 'y') triggerRedo();
                if (k === 's') { saveToBackend(activePaneId); log('Saved'); }
            }
        });

        // --- SEARCH ---
        async function performSearch() {
            const pattern = document.getElementById('searchInput').value;
            if (!pattern) return;
            const res = await apiCall('/api/search', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: getActiveEditor().innerText, pattern })
            });
            const data = await res.json();
            if (data.indices.length > 0) alert(`Found ${data.indices.length} matches.`);
            else alert('Not found');
        }

        function performReplace() {
            const s = document.getElementById('searchInput').value;
            const r = document.getElementById('replaceInput').value;
            if (s) {
                const ed = getActiveEditor();
                ed.innerText = ed.innerText.replaceAll(s, r);
                ed.dispatchEvent(new Event('input'));
            }
        }

        function toggleTheme() {
            const b = document.body;
            b.setAttribute('data-theme', b.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
        }

        function updateStats() {
            const text = getActiveEditor().innerText;
            document.getElementById('lineCount').innerText = text.split('\n').length;
            document.getElementById('wordCount').innerText = text.trim() ? text.trim().split(/\s+/).length : 0;
        }

        function log(msg) { document.getElementById('statusMsg').innerText = msg; }

        // Init
        loadFileList().then(() => {
            if (files.length > 0) openFile(files[0], 'pane1');
            else if (useMock) openFile('demo.txt', 'pane1');
        });

    </script>
</body>

</html>
